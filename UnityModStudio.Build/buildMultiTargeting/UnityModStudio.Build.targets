<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(MSBuildThisFileDirectory)..\build\UnityModStudio.Common.targets" />

  <PropertyGroup>
    <_AllGameVersionsProjectFilePath>$(_FullBaseIntermediateOutputPath)$(MSBuildProjectName).AllGameVersions.targets</_AllGameVersionsProjectFilePath>
  </PropertyGroup>

  <Import Project="$(_GameSpecificPropertiesProjectFilePath)" Condition="Exists('$(_GameSpecificPropertiesProjectFilePath)')" />
  <Import Project="$(_AllGameVersionsProjectFilePath)" Condition="Exists('$(_AllGameVersionsProjectFilePath)')" />

  <Target Name="_CollectGameVersions" Inputs="$(MSBuildAllProjects)" Outputs="$(_AllGameVersionsProjectFilePath)">
    <ItemGroup>
      <_AllGameVersionsForAllTargetFrameworks Remove="@(_AllGameVersionsForAllTargetFrameworks)" />
    </ItemGroup>
    <MSBuild Projects="@(_InnerBuildProjects)" Targets="_GetGameVersions">
      <Output TaskParameter="TargetOutputs" ItemName="_AllGameVersionsForAllTargetFrameworks" />
    </MSBuild>
    <ItemGroup>
      <_AllGameVersionsForAllTargetFrameworks ItemName="_AllGameVersionsForAllTargetFrameworks" />
    </ItemGroup>
    <UpdateProjectFile ProjectFile="$(_AllGameVersionsProjectFilePath)" Items="@(_AllGameVersionsForAllTargetFrameworks)" ItemNames="_AllGameVersionsForAllTargetFrameworks" />
  </Target>

  <Target Name="_AddAllGameVersionsForAllTargetFrameworks" BeforeTargets="DispatchToInnerBuilds" DependsOnTargets="_CollectGameVersions">
    <PropertyGroup>
      <_AllGameVersionsForAllTargetFrameworks>@(_AllGameVersionsForAllTargetFrameworks)</_AllGameVersionsForAllTargetFrameworks>
      <_AllGameVersionsForAllTargetFrameworksEscaped>$([MSBuild]::Escape('$(_AllGameVersionsForAllTargetFrameworks)'))</_AllGameVersionsForAllTargetFrameworksEscaped>
    </PropertyGroup>
    <ItemGroup>
      <_InnerBuildProjects AdditionalProperties="%(AdditionalProperties);_AllGameVersionsForAllTargetFrameworksEscaped=$(_AllGameVersionsForAllTargetFrameworksEscaped)" />
    </ItemGroup>
  </Target>

  <Target Name="_CollectPathsFromInnerBuilds">
    <ItemGroup>
      <_AllTargetDirs Include="@(InnerOutput->'%(RootDir)%(Directory)')" KeepDuplicates="false" />
      <_AllModTargetPaths Include="@(InnerOutput->'%(ModTargetPath)')" KeepDuplicates="false" Condition="'%(InnerOutput.ModDeploymentMode)' == 'Copy'" />
    </ItemGroup>
  </Target>

  <Target Name="CopyOtherGameVersionsCompiledOutput" AfterTargets="Build" DependsOnTargets="_CollectPathsFromInnerBuilds;_CopyOtherGameVersionsCompiledOutput" />

  <Target Name="CreateGameSpecificProperties" AfterTargets="Build" Inputs="$(GameRegistryPath);$(MSBuildAllProjects)" Outputs="$(_GameSpecificPropertiesProjectFilePath)">
    <ItemGroup>
      <_GameSpecificProperty Include="@(InnerOutput->'GamePath_%(SanitizedGameVersion)')" Value="%(InnerOutput.GamePath)" />
      <_GameSpecificProperty Include="@(InnerOutput->'GameExecutableFileName_%(SanitizedGameVersion)')" Value="%(InnerOutput.GameExecutableFileName)" />
      <_GameSpecificProperty Include="@(InnerOutput->'DoorstopMode_%(SanitizedGameVersion)')" Value="%(InnerOutput.DoorstopMode)" />
    </ItemGroup>
    <UpdateProjectFile ProjectFile="$(_GameSpecificPropertiesProjectFilePath)" Properties="@(_GameSpecificProperty)">
      <!-- Property name must correspond to one in UnityModStudio.ProjectSystem.BuildLoggerProvider -->
      <Output TaskParameter="HasWrittenProjectFile" PropertyName="_ReEvaluationRequired" />
    </UpdateProjectFile>
  </Target>

</Project>