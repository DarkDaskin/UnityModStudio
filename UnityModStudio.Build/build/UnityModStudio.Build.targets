<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(MSBuildThisFileDirectory)UnityModStudio.Common.targets" />

  <PropertyGroup>
    <UseGameRegistry Condition="'$(UseGameRegistry)' == ''">true</UseGameRegistry>
    <DoorstopVersion Condition="'$(DoorstopVersion)' == ''">4.4.0</DoorstopVersion>
    <DoorstopSourcePath Condition="'$(DoorstopSourcePath)' == ''">$(BaseIntermediateOutputPath)Doorstop\</DoorstopSourcePath>
    <DoorstopSourcePath Condition="!HasTrailingSlash('$(DoorstopSourcePath)')">$(DoorstopSourcePath)\</DoorstopSourcePath>
    <UseProvidedDoorstop Condition="'$(UseProvidedDoorstop)' == ''">false</UseProvidedDoorstop>
    <_PrimaryDoorstopDllName>winhttp.dll</_PrimaryDoorstopDllName>
    <_AlternateDoorstopDllName>version.dll</_AlternateDoorstopDllName>
    <_DoorstopConfigFileName>doorstop_config.ini</_DoorstopConfigFileName>
    <_SpecifiedGameVersionType>None</_SpecifiedGameVersionType>
    <_SpecifiedGameVersionType Condition="'$(GameVersions)' != ''">Multiple</_SpecifiedGameVersionType>
    <_SpecifiedGameVersionType Condition="'$(GameVersion)' != '' and $(_SpecifiedGameVersionType) != 'Multiple'">Single</_SpecifiedGameVersionType>
    <_FullIntermediateOutputPath>$(IntermediateOutputPath)</_FullIntermediateOutputPath>
    <_FullIntermediateOutputPath Condition="!$([System.IO.Path]::IsPathRooted('$(_FullIntermediateOutputPath)'))">$(MSBuildProjectDirectory)\$(_FullIntermediateOutputPath)</_FullIntermediateOutputPath>
    <_OutputPathsCheckResultProjectFilePath>$(_FullIntermediateOutputPath)$(MSBuildProjectName).OutputPathsCheckResult.targets</_OutputPathsCheckResultProjectFilePath>
  </PropertyGroup>

  <ItemGroup>
    <_AllGameVersions Include="$(GameVersion)" KeepDuplicates="false" Condition="'$(_SpecifiedGameVersionType)' == 'Single'" />
    <_AllGameVersions Include="$(GameVersions)" KeepDuplicates="false" Condition="'$(_SpecifiedGameVersionType)' == 'Multiple'" />
  </ItemGroup>

  <ItemGroup>
    <_AllGameVersionsForAllTargetFrameworks Include="$([MSBuild]::Unescape('$(_AllGameVersionsForAllTargetFrameworksEscaped)'))" Condition="'$(IsInnerBuild)' == 'true'" />
    <_AllGameVersionsForAllTargetFrameworks Include="@(_AllGameVersions)" Condition="'$(IsInnerBuild)' != 'true'" />
  </ItemGroup>

  <PropertyGroup>
    <_EffectiveGameVersionType>None</_EffectiveGameVersionType>
    <_EffectiveGameVersionType Condition="'$(GameVersion)' != '' and ('$(_SpecifiedGameVersionType)' != 'Multiple' or '$(IsSpecificGameVersionBuild)' == 'true')">Single</_EffectiveGameVersionType>
    <_EffectiveGameVersionType Condition="'$(_EffectiveGameVersionType)' != 'Single' and '$(_SpecifiedGameVersionType)' == 'Multiple'">Multiple</_EffectiveGameVersionType>
    <GameVersion Condition="'$(GameVersion)' == '' and '$(_EffectiveGameVersionType)' == 'Single'">$(GameVersions)</GameVersion>
  </PropertyGroup>

  <PropertyGroup Condition="'$(_EffectiveGameVersionType)' == 'Multiple'">
    <_DefaultGameVersionProjectFilePath>$(_FullIntermediateOutputPath)$(MSBuildProjectName).DefaultGameVersion.targets</_DefaultGameVersionProjectFilePath>
  </PropertyGroup>

  <Import Project="$(_DefaultGameVersionProjectFilePath)" Condition="'$(DesignTimeBuild)' == 'true' and Exists('$(_DefaultGameVersionProjectFilePath)')" />

  <PropertyGroup Condition="'$(DesignTimeBuild)' == 'true'">
    <_UserSpecifiedDefaultGameVersion Condition="'$(DefaultGameVersion)' != ''">$(DefaultGameVersion)</_UserSpecifiedDefaultGameVersion>
    <DefaultGameVersion Condition="'$(DefaultGameVersion)' == ''">$(_ResolvedDefaultGameVersion)</DefaultGameVersion>
    <GameVersion Condition="'$(_EffectiveGameVersionType)' == 'Multiple'">$(DefaultGameVersion)</GameVersion>
  </PropertyGroup>

  <Import Project="$(_OutputPathsCheckResultProjectFilePath)" Condition="'$(_SpecifiedGameVersionType)' == 'Multiple' and Exists('$(_OutputPathsCheckResultProjectFilePath)')" />

  <Import Project="$(_GameSpecificPropertiesProjectFilePath)" Condition="'$(_SpecifiedGameVersionType)' == 'Multiple' and '$(IsInnerBuild)' != 'true' and Exists('$(_GameSpecificPropertiesProjectFilePath)')" />

  <PropertyGroup>
    <IntermediateOutputPath Condition="'$(HasIntermediateOutputPathClash)' == 'true'">$(IntermediateOutputPath)$(GameVersion)\</IntermediateOutputPath>
    <OutDir Condition="'$(HasOutDirClash)' == 'true'">$(OutDir)$(GameVersion)\</OutDir>
  </PropertyGroup>

  <PropertyGroup>
    <_ResolvedDataProjectsFileNameSuffix Condition="'$(_EffectiveGameVersionType)' == 'None'" />
    <_ResolvedDataProjectsFileNameSuffix Condition="'$(_EffectiveGameVersionType)' == 'Single'">.$(GameVersion)</_ResolvedDataProjectsFileNameSuffix>
    <_ResolvedDataProjectsFileNameSuffix Condition="'$(_EffectiveGameVersionType)' == 'Multiple'">.$(DefaultGameVersion)</_ResolvedDataProjectsFileNameSuffix>
    <_ResolvedPropertiesProjectFilePath>$(_FullIntermediateOutputPath)$(MSBuildProjectName).ResolvedGameProperties$(_ResolvedDataProjectsFileNameSuffix).targets</_ResolvedPropertiesProjectFilePath>
    <_ResolvedReferencesProjectFilePath>$(_FullIntermediateOutputPath)$(MSBuildProjectName).ResolvedReferences$(_ResolvedDataProjectsFileNameSuffix).targets</_ResolvedReferencesProjectFilePath>
    <_GamePropertiesChangeTimestampFilePath>$(_FullIntermediateOutputPath)$(MSBuildProjectName).GamePropertiesChange$(_ResolvedDataProjectsFileNameSuffix).timestamp</_GamePropertiesChangeTimestampFilePath>
    <_ShouldLoadResolvedGameData Condition="'$(_EffectiveGameVersionType)' != 'Multiple' or ('$(DesignTimeBuild)' == 'true' and '$(DefaultGameVersion)' != '')">true</_ShouldLoadResolvedGameData>
  </PropertyGroup>

  <ItemGroup>
    <_PreExistingReference Include="@(Reference)" />
  </ItemGroup>

  <ImportGroup Condition="'$(_ShouldLoadResolvedGameData)' == 'true'">
    <Import Project="$(_ResolvedPropertiesProjectFilePath)" Condition="Exists('$(_ResolvedPropertiesProjectFilePath)')" />
    <Import Project="$(_ResolvedReferencesProjectFilePath)" Condition="Exists('$(_ResolvedReferencesProjectFilePath)')" />
  </ImportGroup>

  <PropertyGroup Condition="'$(_EffectiveGameVersionType)' == 'Multiple'">  
    <_BuildSpecificGameVersionsTarget Condition="'$(DesignTimeBuild)' == 'true'">GetGamePropertiesAndReferences</_BuildSpecificGameVersionsTarget>
    <_BuildSpecificGameVersionsTarget Condition="'$(DesignTimeBuild)' != 'true'">Build</_BuildSpecificGameVersionsTarget>
  </PropertyGroup>

  <PropertyGroup Condition="'$(_EffectiveGameVersionType)' == 'Multiple'">
    <BuildDependsOn>
      CoreBuild
    </BuildDependsOn>
    <CoreBuildDependsOn>
      _ErrorOnInconsistentGameVersion;
      _ErrorOnSanitizedGameVersionClash;
      BuildSpecificGameVersions
    </CoreBuildDependsOn>
    <RebuildDependsOn>
      Clean;
      Build
    </RebuildDependsOn>
    <CleanDependsOn>
      CleanSpecificGameVersions;
      CoreClean
    </CleanDependsOn>
  </PropertyGroup>

  <ItemGroup>
    <UpToDateCheckBuilt Include="$(_ResolvedPropertiesProjectFilePath)" Original="$(GameRegistryPath)" />
    <UpToDateCheckBuilt Include="$(_ResolvedReferencesProjectFilePath)" Original="$(_GamePropertiesChangeTimestampFilePath)" />
  </ItemGroup>

  <ItemGroup Condition="'$(_EffectiveGameVersionType)' != 'Multiple'">
    <Clean Include="$(_ResolvedPropertiesProjectFilePath)" />
    <Clean Include="$(_ResolvedReferencesProjectFilePath)" />
  </ItemGroup>

  <PropertyGroup Condition="'$(_ShouldLoadResolvedGameData)' == 'true'">
    <GamePath Condition="'$(GamePath)' == ''">$(_ResolvedGamePath)</GamePath>
    <GameModsPath Condition="'$(GameModsPath)' == ''">$(_ResolvedGameModsPath)</GameModsPath>
    <GameExecutableFileName Condition="'$(GameExecutableFileName)' == ''">$(_ResolvedGameExecutableFileName)</GameExecutableFileName>
    <GameInstanceId Condition="'$(GameInstanceId)' == ''">$(_ResolvedGameInstanceId)</GameInstanceId>
    <ModDeploymentMode Condition="'$(ModDeploymentMode)' == ''">$(_ResolvedModDeploymentMode)</ModDeploymentMode>
    <DeploySourceCode Condition="'$(DeploySourceCode)' == ''">$(_ResolvedDeploySourceCode)</DeploySourceCode>
    <DoorstopMode Condition="'$(DoorstopMode)' == ''">$(_ResolvedDoorstopMode)</DoorstopMode>
    <UseAlternateDoorstopDllName Condition="'$(UseAlternateDoorstopDllName)' == ''">$(_ResolvedUseAlternateDoorstopDllName)</UseAlternateDoorstopDllName>
  </PropertyGroup>

  <PropertyGroup>
    <GamePath>$([MSBuild]::EnsureTrailingSlash('$(GamePath)'))</GamePath>
    <GameModsPath>$([MSBuild]::EnsureTrailingSlash('$(GameModsPath)'))</GameModsPath>
  </PropertyGroup>

  <PropertyGroup>
    <OutputPath>$(OutDir)</OutputPath>
    <TargetDir>$([MSBuild]::Escape($([System.IO.Path]::GetFullPath(`$([System.IO.Path]::Combine(`$(MSBuildProjectDirectory)`, `$(OutDir)`))`))))</TargetDir>
    <TargetPath>$(TargetDir)$(TargetFileName)</TargetPath>
  </PropertyGroup>

  <Target Name="_GetGameVersions" Returns="@(_AllGameVersions)" />

  <Target Name="_RemoveNetStandardReferences" BeforeTargets="BeforeBuild" Condition="'$(TargetFrameworkIdentifier)' == '.NETStandard'">
    <ItemGroup>
      <Reference Remove="@(Reference)" Condition="'%(Reference.NuGetPackageId)' == 'NETStandard.Library'" />
    </ItemGroup>
  </Target>

  <Target Name="_RemoveIncompatiblePackageReferences" AfterTargets="ResolveLockFileReferences" Condition="'$(TargetFrameworkIdentifier)' == '.NETStandard'">
    <ItemGroup>
      <Reference Remove="@(Reference)" Condition="'%(Reference.NuGetPackageId)' == 'System.Runtime'" />
    </ItemGroup>
  </Target>

  <Target Name="PrepareForUpToDateCheckBuilt" BeforeTargets="CollectUpToDateCheckBuiltDesignTime" DependsOnTargets="_GetSpecificGameVersionBuildProperties" Condition="'$(_SpecifiedGameVersionType)' == 'Multiple'">
    <PropertyGroup>
      <SkipCopyBuildProduct>true</SkipCopyBuildProduct>
      <_DocumentationFileProduced>false</_DocumentationFileProduced>
      <_DebugSymbolsProduced>false</_DebugSymbolsProduced>
    </PropertyGroup>
    <ItemGroup>
      <IntermediateAssembly Remove="@(IntermediateAssembly)" />
    </ItemGroup>
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_PrepareForUpToDateCheckBuiltInner" Properties="GameVersion=%(_AllGameVersions.Identity);$(_SpecificGameVersionBuildProperties)">
      <Output TaskParameter="TargetOutputs" ItemName="UpToDateCheckBuilt" />
    </MSBuild>
    <Message Text="@(UpToDateCheckBuilt)" />
  </Target>

  <Target Name="_PrepareForUpToDateCheckBuiltInner" Returns="@(UpToDateCheckBuilt)" DependsOnTargets="CompileDesignTime">
    <!-- Copied from https://github.com/dotnet/project-system/blob/77f6d69c2105929bcbbfe3532e851c41802ce802/src/Microsoft.VisualStudio.ProjectSystem.Managed/ProjectSystem/DesignTimeTargets/Microsoft.Managed.DesignTime.targets#L426-L443 -->
    <ItemGroup>
      <!-- Assembly output, bin and obj -->
      <UpToDateCheckBuilt Condition="'$(CopyBuildOutputToOutputDirectory)' != 'false' and '$(SkipCopyBuildProduct)' != 'true'" Include="$(TargetPath)"/>
      <UpToDateCheckBuilt Include="@(IntermediateAssembly)"/>

      <!-- Documentation file, bin and obj -->
      <UpToDateCheckBuilt Condition="'$(_DocumentationFileProduced)'=='true'" Include="@(FinalDocFile)"/>
      <UpToDateCheckBuilt Condition="'$(_DocumentationFileProduced)'=='true'" Include="@(DocFileItem)"/>

      <!-- Symbols, bin and obj -->
      <UpToDateCheckBuilt Condition="'$(_DebugSymbolsProduced)'=='true'" Include="@(_DebugSymbolsIntermediatePath)"/>
      <UpToDateCheckBuilt Condition="'$(_DebugSymbolsProduced)'=='true' and '$(SkipCopyingSymbolsToOutputDirectory)' != 'true' and '$(CopyOutputSymbolsToOutputDirectory)' != 'false'" Include="@(_DebugSymbolsOutputPath)"/>
    </ItemGroup>
  </Target>

  <Target Name="CleanResolvedData" AfterTargets="CoreClean" Condition="'$(IsSpecificGameVersionBuild)' != 'true'">
    <PropertyGroup>
      <GamePath Condition="'$(_UserSpecifiedGamePath)' == ''" />
      <GameModsPath Condition="'$(_UserSpecifiedGameModsPath)' == ''" />
      <GameExecutableFileName Condition="'$(_UserSpecifiedGameExecutableFileName)' == ''" />
      <GameInstanceId Condition="'$(_UserSpecifiedGameInstanceId)' == ''" />
      <ModDeploymentMode Condition="'$(_UserSpecifiedModDeploymentMode)' == ''" />
      <DeploySourceCode Condition="'$(_UserSpecifiedDeploySourceCode)' == ''" />
      <DoorstopMode Condition="'$(_UserSpecifiedDoorstopMode)' == ''" />
      <UseAlternateDoorstopDllName Condition="'$(_UserSpecifiedUseAlternateDoorstopDllName)' == ''" />
      <GameArchitecture Condition="'$(_UserSpecifiedGameArchitecture)' == ''" />
    </PropertyGroup>
    <ItemGroup>
      <Reference Remove="@(Reference)" Condition="'%(Reference.IsImplicitlyDefinedGameReference)' == 'true'" />
    </ItemGroup>
  </Target>

  <Target Name="_ErrorOnInconsistentGameVersion" BeforeTargets="PrepareForBuild" Condition="'$(GameVersions)' != ''">
    <ItemGroup>
      <_AllGameVersionsIncludingCurrent Include="@(_AllGameVersions)" />
      <_AllGameVersionsIncludingCurrent Include="$(GameVersion)" KeepDuplicates="false" Condition="'$(GameVersion)' != ''" />
      <_AllGameVersionsIncludingDefault Include="@(_AllGameVersions)" />
      <_AllGameVersionsIncludingDefault Include="$(DefaultGameVersion)" KeepDuplicates="false" Condition="'$(DefaultGameVersion)' != ''" />
    </ItemGroup>
    <Error Code="UMS0004" Text="Specified GameVersion must be one of specified GameVersions." Condition="@(_AllGameVersionsIncludingCurrent->Count()) > @(_AllGameVersions->Count())" />
    <Error Code="UMS0005" Text="Specified DefaultGameVersion must be one of specified GameVersions." Condition="@(_AllGameVersionsIncludingDefault->Count()) > @(_AllGameVersions->Count())" />
  </Target>

  <Target Name="ResolveDefaultGameVersion" Condition="'$(_UserSpecifiedDefaultGameVersion)' == ''" Inputs="$(MSBuildAllProjects)" Outputs="$(_DefaultGameVersionProjectFilePath)">
    <PropertyGroup>
      <DefaultGameVersion>%(_AllGameVersions.Identity)</DefaultGameVersion>
    </PropertyGroup>
    <ItemGroup>
      <_ResolvedDefaultGameVersionProperty Include="_ResolvedDefaultGameVersion" Value="$(DefaultGameVersion)" />
    </ItemGroup>
    <UpdateProjectFile ProjectFile="$(_DefaultGameVersionProjectFilePath)" Properties="@(_ResolvedDefaultGameVersionProperty)" />
  </Target>

  <Target Name="CheckOutputPaths" BeforeTargets="PrepareForBuild" Condition="'$(_SpecifiedGameVersionType)' == 'Multiple'" Inputs="$(MSBuildAllProjects)" Outputs="$(_OutputPathsCheckResultProjectFilePath)">
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GetIntermediateOutputPathForGameVersion" Properties="GameVersion=%(_AllGameVersions.Identity);IsSpecificGameVersionBuild=true">
      <Output TaskParameter="TargetOutputs" ItemName="_AllIntermediateOutputPaths" />
    </MSBuild>
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GetOutDirForGameVersion" Properties="GameVersion=%(_AllGameVersions.Identity);IsSpecificGameVersionBuild=true">
      <Output TaskParameter="TargetOutputs" ItemName="_AllOutDirs" />
    </MSBuild>
    <PropertyGroup>
      <HasIntermediateOutputPathClash Condition="'$(HasIntermediateOutputPathClash)' == ''">false</HasIntermediateOutputPathClash>
      <HasIntermediateOutputPathClash Condition="@(_AllGameVersions->Count()) != @(_AllIntermediateOutputPaths->Distinct()->Count())">true</HasIntermediateOutputPathClash>
      <HasOutDirClash Condition="'$(HasOutDirClash)' == ''">false</HasOutDirClash>
      <HasOutDirClash Condition="@(_AllGameVersions->Count()) != @(_AllOutDirs->Distinct()->Count())">true</HasOutDirClash>
    </PropertyGroup>
    <ItemGroup>
      <_OutputPathsCheckResult Include="HasIntermediateOutputPathClash" Value="$(HasIntermediateOutputPathClash)" />
      <_OutputPathsCheckResult Include="HasOutDirClash" Value="$(HasOutDirClash)" />
    </ItemGroup>
    <UpdateProjectFile ProjectFile="$(_OutputPathsCheckResultProjectFilePath)" Properties="@(_OutputPathsCheckResult)" />
  </Target>

  <Target Name="_GetIntermediateOutputPathForGameVersion" Returns="$(IntermediateOutputPath)" />

  <Target Name="_GetOutDirForGameVersion" Returns="$(OutDir)" />

  <Target Name="_GetSpecificGameVersionBuildProperties" DependsOnTargets="CheckOutputPaths">
    <PropertyGroup>
      <_SpecificGameVersionBuildProperties>
        IsSpecificGameVersionBuild=true;
        HasIntermediateOutputPathClash=$(HasIntermediateOutputPathClash);
        HasOutDirClash=$(HasOutDirClash)
      </_SpecificGameVersionBuildProperties>
      <_SpecificGameVersionBuildProperties Condition="'$(DesignTimeBuild)' == 'true'">
        $(_SpecificGameVersionBuildProperties);
        SkipCompilerExecution=true;
        ProvideCommandLineArgs=true
      </_SpecificGameVersionBuildProperties>
    </PropertyGroup>
  </Target>

  <Target Name="BuildSpecificGameVersions" DependsOnTargets="_GetSpecificGameVersionBuildProperties;ResolveDefaultGameVersion" Returns="@(SpecificGameVersionOutput)">
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="$(_BuildSpecificGameVersionsTarget)" Condition="'$(GameVersion)' == ''"
             Properties="GameVersion=%(_AllGameVersions.Identity);$(_SpecificGameVersionBuildProperties)">
      <Output TaskParameter="TargetOutputs" ItemName="SpecificGameVersionOutput" />
    </MSBuild>
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="$(_BuildSpecificGameVersionsTarget)" Condition="'$(GameVersion)' != ''"
             Properties="GameVersion=$(GameVersion);$(_SpecificGameVersionBuildProperties)">
      <Output TaskParameter="TargetOutputs" ItemName="SpecificGameVersionOutput" />
    </MSBuild>
    <ItemGroup>
      <TargetPathWithTargetPlatformMoniker Include="@(SpecificGameVersionOutput)" />
    </ItemGroup>
  </Target>
  
  <Target Name="CleanSpecificGameVersions">
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="Clean" Properties="GameVersion=%(_AllGameVersions.Identity);IsSpecificGameVersionBuild=true" />
  </Target>

  <Target Name="_SanitizeGameVersion" BeforeTargets="PrepareForBuild" Condition="'$(_EffectiveGameVersionType)' == 'Single'">
    <SanitizeGameVersion Version="$(GameVersion)">
      <Output TaskParameter="SanitizedVersion" PropertyName="SanitizedGameVersion" />
    </SanitizeGameVersion>
  </Target>

  <Target Name="AddGameVersionDefineConstants" AfterTargets="AddImplicitDefineConstants" Condition="'$(_EffectiveGameVersionType)' == 'Single'">
    <GetGameVersionDefineConstants Versions="@(_AllGameVersionsForAllTargetFrameworks)" CurrentVersion="$(GameVersion)">
      <Output TaskParameter="DefineConstants" PropertyName="_GameVersionDefineConstants" />
    </GetGameVersionDefineConstants>
    <PropertyGroup>
      <DefineConstants>$(DefineConstants);$(_GameVersionDefineConstants)</DefineConstants>
    </PropertyGroup>
  </Target>

  <Target Name="GetGeneralSettings">
    <GetGeneralSettings StorePath="$(GeneralSettingsPath)">
      <Output TaskParameter="IsAmbientGameResolutionAllowed" PropertyName="_IsAmbientGameResolutionAllowed" />
      <Output TaskParameter="AmbientGamesDoorstopMode" PropertyName="_AmbientGamesDoorstopMode" />
      <Output TaskParameter="UseAlternateDoorstopDllNameForAmbientGames" PropertyName="_UseAlternateDoorstopDllNameForAmbientGames" />
    </GetGeneralSettings>
  </Target>

  <Target Name="ResolveGameProperties" BeforeTargets="GamePropertiesResolved" DependsOnTargets="GetGeneralSettings" Condition="'$(UseGameRegistry)' == 'true' and '$(_EffectiveGameVersionType)' != 'Multiple'" 
          Inputs="$(GameRegistryPath);$(MSBuildAllProjects)" Outputs="$(_ResolvedPropertiesProjectFilePath)">
    <PropertyGroup>
      <_PreviousGamePath>$(_ResolvedGamePath)</_PreviousGamePath>
    </PropertyGroup>
    <ItemGroup>
      <GameLookupProperty Include="Id" Value="$(GameInstanceId)" Condition="'$(GameInstanceId)' != ''" />
      <GameLookupProperty Include="GameName" Value="$(GameName)" Condition="'$(GameName)' != ''" />
      <GameLookupProperty Include="Version" Value="$(GameVersion)" Condition="'$(GameVersion)' != ''" />
    </ItemGroup>
    <ResolveGameProperties LookupProperties="@(GameLookupProperty)" BuildingInsideVisualStudio="$(BuildingInsideVisualStudio)" ProjectDirectory="$(MSBuildProjectDirectory)" 
                           IsAmbientGameResolutionAllowed="$(_IsAmbientGameResolutionAllowed)" StorePath="$(GameRegistryPath)">
      <Output TaskParameter="GamePath" PropertyName="_ResolvedGamePath" />
      <Output TaskParameter="GameModsPath" PropertyName="_ResolvedGameModsPath" />
      <Output TaskParameter="GameExecutableFileName" PropertyName="_ResolvedGameExecutableFileName" />
      <Output TaskParameter="GameInstanceId" PropertyName="_ResolvedGameInstanceId" />
      <Output TaskParameter="ModDeploymentMode" PropertyName="_ResolvedModDeploymentMode" />
      <Output TaskParameter="DeploySourceCode" PropertyName="_ResolvedDeploySourceCode" />
      <Output TaskParameter="DoorstopMode" PropertyName="_ResolvedDoorstopMode" />
      <Output TaskParameter="UseAlternateDoorstopDllName" PropertyName="_ResolvedUseAlternateDoorstopDllName" />
      <Output TaskParameter="IsAmbientGame" PropertyName="_IsAmbientGame" />
    </ResolveGameProperties>

    <Error Text="Building multi-version mod for an ambient game is not supported." Condition="'$(_IsAmbientGame)' == 'true' and '$(_SpecifiedGameVersionType)' == 'Multiple'" />

    <PropertyGroup Condition="'$(_IsAmbientGame)' == 'true'">
      <_ResolvedDoorstopMode>$(_AmbientGamesDoorstopMode)</_ResolvedDoorstopMode>
      <_ResolvedUseAlternateDoorstopDllName>$(_UseAlternateDoorstopDllNameForAmbientGames)</_ResolvedUseAlternateDoorstopDllName>
    </PropertyGroup>
    <ItemGroup>
      <_ResolvedProperty Include="_ResolvedGamePath" Value="$(_ResolvedGamePath)" Condition="'$(_ResolvedGamePath)' != ''" />
      <_ResolvedProperty Include="_ResolvedGameModsPath" Value="$(_ResolvedGameModsPath)" Condition="'$(_ResolvedGameModsPath)' != ''" />
      <_ResolvedProperty Include="_ResolvedGameExecutableFileName" Value="$(_ResolvedGameExecutableFileName)" Condition="'$(_ResolvedGameExecutableFileName)' != ''" />
      <_ResolvedProperty Include="_ResolvedGameInstanceId" Value="$(_ResolvedGameInstanceId)" Condition="'$(_ResolvedGameInstanceId)' != ''" />
      <_ResolvedProperty Include="_ResolvedModDeploymentMode" Value="$(_ResolvedModDeploymentMode)" Condition="'$(_ResolvedModDeploymentMode)' != ''" />
      <_ResolvedProperty Include="_ResolvedDeploySourceCode" Value="$(_ResolvedDeploySourceCode)" Condition="'$(_ResolvedDeploySourceCode)' != ''" />
      <_ResolvedProperty Include="_ResolvedDoorstopMode" Value="$(_ResolvedDoorstopMode)" Condition="'$(_ResolvedDoorstopMode)' != ''" />
      <_ResolvedProperty Include="_ResolvedUseAlternateDoorstopDllName" Value="$(_ResolvedUseAlternateDoorstopDllName)" Condition="'$(_ResolvedUseAlternateDoorstopDllName)' != ''" />
    </ItemGroup>
    <UpdateProjectFile ProjectFile="$(_ResolvedPropertiesProjectFilePath)" Properties="@(_ResolvedProperty)" />
    <Touch Files="$(_ResolvedPropertiesProjectFilePath)" />

    <PropertyGroup>
      <_GamePathChanged Condition="'$(_ResolvedGamePath)' != '$(_PreviousGamePath)'">true</_GamePathChanged>
    </PropertyGroup>

    <PropertyGroup>
      <GamePath Condition="'$(_UserSpecifiedGamePath)' == ''">$(_ResolvedGamePath)</GamePath>
      <GameModsPath Condition="'$(_UserSpecifiedGameModsPath)' == ''">$(_ResolvedGameModsPath)</GameModsPath>
      <GameExecutableFileName Condition="'$(_UserSpecifiedGameExecutableFileName)' == ''">$(_ResolvedGameExecutableFileName)</GameExecutableFileName>
      <GameInstanceId Condition="'$(_UserSpecifiedGameInstanceId)' == ''">$(_ResolvedGameInstanceId)</GameInstanceId>
      <ModDeploymentMode Condition="'$(_UserSpecifiedModDeploymentMode)' == ''">$(_ResolvedModDeploymentMode)</ModDeploymentMode>
      <DeploySourceCode Condition="'$(_UserSpecifiedDeploySourceCode)' == ''">$(_ResolvedDeploySourceCode)</DeploySourceCode>
      <DoorstopMode Condition="'$(_UserSpecifiedDoorstopMode)' == ''">$(_ResolvedDoorstopMode)</DoorstopMode>
      <UseAlternateDoorstopDllName Condition="'$(_UserSpecifiedUseAlternateDoorstopDllName)' == ''">$(_ResolvedUseAlternateDoorstopDllName)</UseAlternateDoorstopDllName>
    </PropertyGroup>
  </Target>

  <Target Name="GamePropertiesResolved" />

  <Target Name="UpdateGamePropertiesChangeTimestamp" BeforeTargets="ResolveGameAssemblyReferences" 
          Condition="'$(_EffectiveGameVersionType)' != 'Multiple' and ('$(_GamePathChanged)' == 'true' or !Exists('$(_GamePropertiesChangeTimestampFilePath)'))">
    <Touch Files="$(_GamePropertiesChangeTimestampFilePath)" AlwaysCreate="true" />
  </Target>

  <Target Name="ResolveGameAssemblyReferences" BeforeTargets="ResolveAssemblyReferences;GameAssemblyReferencesResolved" DependsOnTargets="GamePropertiesResolved" 
          Inputs="$(_GamePropertiesChangeTimestampFilePath);$(MSBuildAllProjects)" Outputs="$(_ResolvedReferencesProjectFilePath)" Condition="'$(_EffectiveGameVersionType)' != 'Multiple'">
    <CreateProperty Value="true">
      <Output TaskParameter="ValueSetByTask" PropertyName="_ResolveGameAssemblyReferencesIsRunning" />
    </CreateProperty>

    <ItemGroup Condition="'$(_ResolveGameAssemblyReferencesIsRunning)' == 'true'">
      <Reference Remove="@(Reference->WithMetadataValue('IsImplicitlyDefinedGameReference', 'true'))" />
    </ItemGroup>

    <ResolveGameAssemblyReferences GamePath="$(GamePath)" TargetFramework="$(TargetFramework)" ExistingReferences="@(_PreExistingReference)">
      <Output TaskParameter="Architecture" PropertyName="GameArchitecture" />
      <Output TaskParameter="ReferencesToAdd" ItemName="_GameReferencesToAdd" />
      <Output TaskParameter="ReferencesToUpdate" ItemName="_GameReferencesToUpdate" />
      <Output TaskParameter="ReferencesToRemove" ItemName="_GameReferencesToRemove" />
    </ResolveGameAssemblyReferences>

    <ItemGroup>
      <_ResolvedReferenceProperty Include="GameArchitecture" Value="$(GameArchitecture)" />
      <_GameReferenceToSave Include="@(_GameReferencesToAdd)" ItemName="Reference" ItemAction="Include" IncludeMetadata="HintPath;Private;IsImplicitlyDefined;IsImplicitlyDefinedGameReference"
                            Condition="'$(DisableImplicitFrameworkReferences)' != 'true'" />
      <_GameReferenceToSave Include="@(_GameReferencesToUpdate)" ItemName="Reference" ItemAction="Update" IncludeMetadata="HintPath;Private" />
      <_GameReferenceToSave Include="@(_GameReferencesToRemove)" ItemName="Reference" ItemAction="Remove" />
    </ItemGroup>

    <ItemGroup Condition="'$(_ResolveGameAssemblyReferencesIsRunning)' == 'true'">
      <Reference Remove="@(_GameReferencesToRemove)" />
      <Reference Update="@(_GameReferencesToUpdate)" HintPath="%(_GameReferencesToUpdate.HintPath)" Private="%(_GameReferencesToUpdate.Private)" />
      <Reference Include="@(_GameReferencesToAdd)" Condition="'$(DisableImplicitFrameworkReferences)' != 'true'" />
    </ItemGroup>

    <UpdateProjectFile ProjectFile="$(_ResolvedReferencesProjectFilePath)" Properties="@(_ResolvedReferenceProperty)" Items="@(_GameReferenceToSave)" ItemNames="Reference">
      <!-- Property name must correspond to one in UnityModStudio.ProjectSystem.BuildLoggerProvider -->
      <Output TaskParameter="HasWrittenProjectFile" PropertyName="_ReEvaluationRequired" />
    </UpdateProjectFile>
  </Target>

  <Target Name="GameAssemblyReferencesResolved" />

  <Target Name="_PrepareModPathsRegular" DependsOnTargets="GamePropertiesResolved" Condition="'$(_IsAmbientGame)' != 'true'">
    <PropertyGroup>
      <GameModsPath Condition="'$(GameModsPath)' == ''">.\</GameModsPath>
    </PropertyGroup>
    <CombinePath BasePath="$(GamePath)" Paths="$(GameModsPath)">
      <Output TaskParameter="CombinedPaths" PropertyName="GameModsPath" />
    </CombinePath>

    <PropertyGroup>
      <ModTargetPath Condition="'$(ModTargetPath)' == ''">$(GameModsPath)$(ProjectName)\</ModTargetPath>
      <ModSourcePath Condition="'$(ModSourcePath)' == ''">$(TargetDir)</ModSourcePath>
    </PropertyGroup>

    <ConvertToAbsolutePath Paths="$(ModSourcePath)">
      <Output TaskParameter="AbsolutePaths" PropertyName="ModSourcePath" />
    </ConvertToAbsolutePath>

    <ItemGroup>
      <_CompiledModAssembly Include="$(TargetPath)" />
    </ItemGroup>
    <ResolveTargetPath RelativeToPath="$(ModSourcePath)" Input="@(_CompiledModAssembly)">
      <Output TaskParameter="Output" ItemName="_ResolvedCompiledModAssembly" />
    </ResolveTargetPath>
    <PropertyGroup>
      <DeployedModAssemblyPath>$(ModTargetPath)%(_ResolvedCompiledModAssembly.TargetPath)$(TargetFileName)</DeployedModAssemblyPath>
    </PropertyGroup>
  </Target>

  <Target Name="_PrepareModPathsAmbient" DependsOnTargets="GamePropertiesResolved" Condition="'$(_IsAmbientGame)' == 'true'">
    <PropertyGroup>
      <DeployedModAssemblyPath>$(TargetPath)</DeployedModAssemblyPath>
    </PropertyGroup>
  </Target>

  <Target Name="PrepareModPaths" DependsOnTargets="_PrepareModPathsRegular;_PrepareModPathsAmbient" />

  <Target Name="GetModSourceCodeFiles" BeforeTargets="CopyModFilesToGame" DependsOnTargets="PrepareModPaths" Condition="'$(DeploySourceCode)' == 'true'">
    <ItemGroup>
      <_IgnoreListFile Include="$(ModSourcePath)**\.gitignore" />
      <_IgnoreListFile Include="$(MSBuildThisFileDirectory)..\tools\default.gitignore" Condition="'@(_IgnoreListFile)' == ''" />
    </ItemGroup>
    <GetIgnoredFiles Directory="$(ModSourcePath)" IgnoreListFiles="@(_IgnoreListFile)">
      <Output TaskParameter="IgnoredFiles" ItemName="_IgnoredFile" />
    </GetIgnoredFiles>

    <ItemGroup>
      <ModSourceCodeFile Include="$(ModSourcePath)**\*" Exclude="@(_IgnoredFile);$(TargetDir)**" />
    </ItemGroup>

    <Warning Code="UMS0009" Text="No source code files found." Condition="'@(ModSourceCodeFile)' == ''" />
  </Target>

  <!-- Not so fun fact: formerly named CopyModToGame, that name broke MSBuild somehow -->
  <Target Name="CopyModFilesToGame" AfterTargets="PrepareForRun" DependsOnTargets="PrepareModPaths" Condition="'$(ModDeploymentMode)' == 'Copy'">
    <ItemGroup>
      <_ModCompiledOutput Include="$(TargetDir)**\*" />
      <_ModContentFile Include="@(Content)" />
      <ModExcludedFile />
      <ModFile Include="%(_ModCompiledOutput.FullPath)" KeepDuplicates="false" />
      <ModFile Include="%(_ModContentFile.FullPath)" KeepDuplicates="false" />
      <ModFile Include="%(ModSourceCodeFile.FullPath)" KeepDuplicates="false" />
      <ModFile Remove="%(ModExcludedFile.FullPath)" />
    </ItemGroup>
    <ResolveTargetPath RelativeToPath="$(ModSourcePath)" Input="@(ModFile)">
      <Output TaskParameter="Output" ItemName="_ModFileToCopy" />
    </ResolveTargetPath>
    
    <GetSymbolicLinkTarget SymbolicLink="$(ModTargetPath)">
      <Output TaskParameter="Target" PropertyName="_ModTargetPathLinkTarget" />
    </GetSymbolicLinkTarget>
    <DeleteSymbolicLink Path="$(ModTargetPath)" Condition="Exists('$(ModTargetPath)') and '$(_ModTargetPathLinkTarget)' != ''" />

    <MakeDir Directories="$(ModTargetPath)" Condition="!Exists('$(ModTargetPath)')" />
    <Copy SourceFiles="@(_ModFileToCopy->HasMetadata('TargetPath'))" DestinationFolder="$(ModTargetPath)%(TargetPath)" SkipUnchangedFiles="true">
      <Output TaskParameter="CopiedFiles" ItemName="_FileCopiedToModTargetPath" />
    </Copy>

    <ItemGroup>
      <_FileToRemoveFromModTargetPath Include="$(ModTargetPath)**\*" />
      <_FileToRemoveFromModTargetPath Remove="@(_FileCopiedToModTargetPath)" MatchOnMetadata="FullPath" />
    </ItemGroup>
    <Delete Files="@(_FileToRemoveFromModTargetPath)" />
    <RemoveEmptyDirectories Directories="$(ModTargetPath)" />
  </Target>

  <Target Name="LinkModToGame" AfterTargets="PrepareForRun" DependsOnTargets="PrepareModPaths" Condition="'$(ModDeploymentMode)' == 'Link'">
    <GetSymbolicLinkTarget SymbolicLink="$(ModTargetPath)">
      <Output TaskParameter="Target" PropertyName="_ModTargetPathLinkTarget" />
    </GetSymbolicLinkTarget>
    <ConvertToAbsolutePath Paths="$(_ModTargetPathLinkTarget)" Condition="'$(_ModTargetPathLinkTarget)' != ''">
      <Output TaskParameter="AbsolutePaths" PropertyName="_ModTargetPathLinkTarget" />
    </ConvertToAbsolutePath>
    <RemoveDir Directories="$(ModTargetPath)" Condition="Exists('$(ModTargetPath)') and '$(_ModTargetPathLinkTarget)' == ''" />
    <DeleteSymbolicLink Path="$(ModTargetPath)" Condition="Exists('$(ModTargetPath)') and '$(_ModTargetPathLinkTarget)' != '' and '$(_ModTargetPathLinkTarget)' != '$(ModSourcePath)'" />

    <CreateSymbolicLink Target="$(ModSourcePath)" SymbolicLink="$(ModTargetPath)" Condition="!Exists('$(ModTargetPath)')" />    
  </Target>

<Target Name="_VerifyDoorstopVersion">
    <Error Code="UMS0014" Text="Unity Doorstop version is not specified." Condition="'$(DoorstopVersion)' == ''" />  

    <PropertyGroup>
      <_MinDoorstopVersion>4.0.0</_MinDoorstopVersion>
    </PropertyGroup>
    <Error Code="UMS0015" Text="Specified Unity Doorstop version ($(DoorstopVersion)) is less than minimum supported version ($(_MinDoorstopVersion))."
           Condition="$([MSBuild]::VersionLessThan('$(DoorstopVersion)', '$(_MinDoorstopVersion)'))" />
  </Target>

  <Target Name="_GetDoorstopSourcePaths">
    <PropertyGroup>
      <_DoorstopArchitectureSpecificSourcePath>$(DoorstopSourcePath)$(GameArchitecture.ToLowerInvariant())\</_DoorstopArchitectureSpecificSourcePath>
      <_DoorstopDllSourcePath>$(_DoorstopArchitectureSpecificSourcePath)$(_PrimaryDoorstopDllName)</_DoorstopDllSourcePath>
      <_DoorstopConfigSourcePath>$(_DoorstopArchitectureSpecificSourcePath)$(_DoorstopConfigFileName)</_DoorstopConfigSourcePath>
    </PropertyGroup>
  </Target>

  <Target Name="_GetExistingDoorstopVersion" DependsOnTargets="_GetDoorstopSourcePaths">
    <GetFileVersion Path="$(_DoorstopDllSourcePath)" Condition="Exists('$(_DoorstopDllSourcePath)')">
      <Output TaskParameter="FileVersion" PropertyName="_ExistingDoorstopVersion" />
    </GetFileVersion>
  </Target>

  <Target Name="DownloadDoorstop" DependsOnTargets="_GetExistingDoorstopVersion" Condition="'$(UseProvidedDoorstop)' != 'true' and ('$(_ExistingDoorstopVersion)' == '' or $([MSBuild]::VersionNotEquals('$(_ExistingDoorstopVersion)', '$(DoorstopVersion)')))">
    <PropertyGroup>
      <_DoorstopReleaseFileName>doorstop_win_release_$(DoorstopVersion).zip</_DoorstopReleaseFileName>
      <_DoorstopReleaseUrl>https://github.com/NeighTools/UnityDoorstop/releases/download/v$(DoorstopVersion)/$(_DoorstopReleaseFileName)</_DoorstopReleaseUrl>
    </PropertyGroup>
    <ItemGroup>
      <_DoorstopOldFiles Include="$(DoorstopSourcePath)**\*" />
    </ItemGroup>
    <Delete Files="@(_DoorstopOldFiles)" />
    <DownloadFile SourceUrl="$(_DoorstopReleaseUrl)" DestinationFolder="$(DoorstopSourcePath)" />
    <Unzip SourceFiles="$(DoorstopSourcePath)$(_DoorstopReleaseFileName)" DestinationFolder="$(DoorstopSourcePath)" />
    <Delete Files="$(DoorstopSourcePath)$(_DoorstopReleaseFileName)" />
    <ItemGroup>
      <FileWrites Include="$(DoorstopSourcePath)**\*" />
    </ItemGroup>
  </Target>

  <Target Name="DeployDoorstop" DependsOnTargets="GamePropertiesResolved;GameAssemblyReferencesResolved;_GetDoorstopSourcePaths;_GetExistingDoorstopVersion;DownloadDoorstop" 
          Condition="'$(DoorstopMode)' != '' and '$(DoorstopMode)' != 'Disabled'">
    <Error Code="UMS0010" Text="No Unity Doorstop files are available for architecture '$(GameArchitecture)'." Condition="!Exists('$(_DoorstopDllSourcePath)') or !Exists('$(_DoorstopConfigSourcePath)')" />

    <PropertyGroup>
      <_PrimaryDoorstopDllTargetPath>$(GamePath)$(_PrimaryDoorstopDllName)</_PrimaryDoorstopDllTargetPath>
      <_AlternateDoorstopDllTargetPath>$(GamePath)$(_AlternateDoorstopDllName)</_AlternateDoorstopDllTargetPath>
      <_DoorstopConfigTargetPath>$(GamePath)$(_DoorstopConfigFileName)</_DoorstopConfigTargetPath>
    </PropertyGroup>

    <Copy SourceFiles="$(_DoorstopDllSourcePath)" DestinationFiles="$(_PrimaryDoorstopDllTargetPath)" SkipUnchangedFiles="True" Condition="'$(UseAlternateDoorstopDllName)' != 'true'" />
    <Copy SourceFiles="$(_DoorstopDllSourcePath)" DestinationFiles="$(_AlternateDoorstopDllTargetPath)" SkipUnchangedFiles="True" Condition="'$(UseAlternateDoorstopDllName)' == 'true'" />
    <Delete Files="$(_PrimaryDoorstopDllTargetPath)" Condition="Exists('$(_PrimaryDoorstopDllTargetPath)') and '$(UseAlternateDoorstopDllName)' == 'true'" />
    <Delete Files="$(_AlternateDoorstopDllTargetPath)" Condition="Exists('$(_AlternateDoorstopDllTargetPath)') and '$(UseAlternateDoorstopDllName)' != 'true'" />
    <Copy SourceFiles="$(_DoorstopConfigSourcePath)" DestinationFiles="$(_DoorstopConfigTargetPath)" Condition="!Exists('$(_DoorstopConfigTargetPath)')" />
  </Target>

  <Target Name="ConfigureDoorstop" AfterTargets="CopyModFilesToGame;LinkModToGame" DependsOnTargets="DeployDoorstop;PrepareModPaths" Condition="'$(DoorstopMode)' != '' and '$(DoorstopMode)' != 'Disabled'">
    <PropertyGroup>
      <DoorstopTargetAssemblyPath Condition="'$(DoorstopTargetAssemblyPath)' == ''">$(DeployedModAssemblyPath)</DoorstopTargetAssemblyPath>
      <_UseDoorstopForModLoading>false</_UseDoorstopForModLoading>
      <_UseDoorstopForModLoading Condition="'$(DoorstopMode)' == 'DebuggingAndModLoading'">true</_UseDoorstopForModLoading>
    </PropertyGroup>

    <ConfigureDoorstop ConfigPath="$(_DoorstopConfigTargetPath)" TargetAssemblyPath="$(DoorstopTargetAssemblyPath)" UseForModLoading="$(_UseDoorstopForModLoading)" />
  </Target>

  <Target Name="_CollectPathsFromSpecificGameVersionBuilds">
    <ItemGroup>
      <_AllTargetDirs Include="@(SpecificGameVersionOutput->'%(RootDir)%(Directory)')" KeepDuplicates="false" />
      <_AllModTargetPaths Include="@(SpecificGameVersionOutput->'%(ModTargetPath)')" KeepDuplicates="false" Condition="'%(SpecificGameVersionOutput.ModDeploymentMode)' == 'Copy'" />
    </ItemGroup>
  </Target>

  <Target Name="CopyOtherGameVersionsCompiledOutput" AfterTargets="BuildSpecificGameVersions" DependsOnTargets="_CollectPathsFromSpecificGameVersionBuilds;_CopyOtherGameVersionsCompiledOutput"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(IsInnerBuild)' != 'true' and '$(GameVersion)' == ''" />

  <Target Name="CreateGameSpecificProperties" AfterTargets="BuildSpecificGameVersions" Condition="'$(IsInnerBuild)' != 'true'"
          Inputs="$(GameRegistryPath);$(MSBuildAllProjects)" Outputs="$(_GameSpecificPropertiesProjectFilePath)">
    <ItemGroup>
      <_GameSpecificProperty Include="@(SpecificGameVersionOutput->'GamePath_%(SanitizedGameVersion)')" Value="%(SpecificGameVersionOutput.GamePath)" />
      <_GameSpecificProperty Include="@(SpecificGameVersionOutput->'GameExecutableFileName_%(SanitizedGameVersion)')" Value="%(SpecificGameVersionOutput.GameExecutableFileName)" />
      <_GameSpecificProperty Include="@(SpecificGameVersionOutput->'DoorstopMode_%(SanitizedGameVersion)')" Value="%(SpecificGameVersionOutput.DoorstopMode)" />
    </ItemGroup>
    <UpdateProjectFile ProjectFile="$(_GameSpecificPropertiesProjectFilePath)" Properties="@(_GameSpecificProperty)">
      <!-- Property name must correspond to one in UnityModStudio.ProjectSystem.BuildLoggerProvider -->
      <Output TaskParameter="HasWrittenProjectFile" PropertyName="_ReEvaluationRequired" />
    </UpdateProjectFile>
  </Target>

  <Target Name="_AddGameSpecificMetadata" AfterTargets="AfterBuild" DependsOnTargets="PrepareModPaths">
    <ItemGroup>
      <TargetPathWithTargetPlatformMoniker GameVersion="$(GameVersion)" SanitizedGameVersion="$(SanitizedGameVersion)" GamePath="$(GamePath)" GameExecutableFileName="$(GameExecutableFileName)"
                                           DoorstopMode="$(DoorstopMode)" ModDeploymentMode="$(ModDeploymentMode)" ModSourcePath="$(ModSourcePath)" ModTargetPath="$(ModTargetPath)" />
    </ItemGroup>
  </Target>

  <Target Name="GetGamePropertiesAndReferences" DependsOnTargets="GameAssemblyReferencesResolved" Returns="@(SpecificGameVersionOutput)">
    <ItemGroup>
      <SpecificGameVersionOutput Include="@(Reference)" OutputType="Reference" />
      <SpecificGameVersionOutput Include="GameVersion" Value="$(GameVersion)" OutputType="GameProperty" />
      <SpecificGameVersionOutput GameVersion="$(GameVersion)" />
    </ItemGroup>
  </Target>

  <Target Name="_ReplaceAssemblyReferences" BeforeTargets="ResolveAssemblyReferences" DependsOnTargets="BuildSpecificGameVersions" Condition="'$(DesignTimeBuild)' == 'true' and '$(_EffectiveGameVersionType)' == 'Multiple'">
    <ItemGroup>
      <Reference Remove="@(Reference)" Condition="'%(Reference.IsImplicitlyDefined)' == 'true'" />
      <Reference Include="@(SpecificGameVersionOutput)" Condition="'%(SpecificGameVersionOutput.OutputType)' == 'Reference' and '%(SpecificGameVersionOutput.GameVersion)' == '$(DefaultGameVersion)'" />
    </ItemGroup>
    <PropertyGroup>
      <GameVersion Condition="'$(GameVersion)' == '' and '%(SpecificGameVersionOutput.OutputType)' == 'GameProperty' and '%(SpecificGameVersionOutput.GameVersion)' == '$(DefaultGameVersion)'">%(SpecificGameVersionOutput.Value)</GameVersion>
    </PropertyGroup>
  </Target>

</Project>